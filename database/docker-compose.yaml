###
### junand 11.03.2020
###

# database/docker-compose.yaml

networks:

    proxy:
        external: true

    backbone:
        external: true

services:

    influxdb:
        # 25.02.2026
        # On April 7, 2026, the latest tag for InfluxDB Docker images will point to InfluxDB 3 Core.
        # To avoid unexpected upgrades, use specific version tags in your Docker deployments.
        # For example, if using Docker to run InfluxDB v2, replace the latest version tag with
        # a specific version tag in your Docker pull commandâ€“for example: docker pull influxdb:2
        image: ${DOCKER_REGISTRY}influxdb:2
        container_name: influxdb
        restart: ${DOCKER_RESTART_POLICY}
        environment:
          - TZ=Europe/Berlin
          - INFLUXDB_REPORTING_DISABLED=true
        labels:
          - "traefik.enable=true"
          - "traefik.http.routers.dontuse.entrypoints=dontuse"
          - "traefik.docker.network=proxy"
        expose:
          - "8086"
        volumes:
          - "~/docker/influxdb/v2:/var/lib/influxdb2"
          - "~/docker/influxdb/v2:/etc/influxdb2"
        networks:
          - proxy
          - backbone

    telegraf_logs:
        image: ${DOCKER_REGISTRY}telegraf:latest
        container_name: telegraf_logs
        restart: ${DOCKER_RESTART_POLICY}
        # https://www.influxdata.com/blog/docker-run-telegraf-as-non-root/
        # telegraf is running at user telegraf, so we have set the conatiner user and add to him all necessary groups
        user: telegraf
        group_add:
          - "${GROUP_ID_VAR_LOG_SYSLOG}"
          - "${GROUP_ID_VAR_RUN_DOCKER_SOCK}"
        environment:
          - TZ=Europe/Berlin
          - INFLUX_TOKEN=${INFLUX_TOKEN}
          - PARENT_HOSTNAME=${HOSTNAME}
        labels:
          - "traefik.enable=true"
          - "traefik.tcp.routers.syslog.tls=false"
          - "traefik.tcp.services.telegraf-logs-database.loadbalancer.server.port=6514"
          - "traefik.docker.network=proxy"
        depends_on:
          - influxdb
        expose:
          - "6514/udp"
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock
          - ./telegraf_logs.conf:/etc/telegraf/telegraf.conf:ro
          # telegraf container dont know syslog
          # - /var/log/syslog:/logs/syslog
          - /var/log/:/logs/
        networks:
          - proxy
          - backbone

    telegraf:
        image: ${DOCKER_REGISTRY}telegraf:latest
        container_name: telegraf
        restart: ${DOCKER_RESTART_POLICY}
        environment:
          - TZ=Europe/Berlin
          - INFLUX_TOKEN=${INFLUX_TOKEN}
          - HOSTNAME=${HOSTNAME}
        labels:
          - "traefik.enable=false"
        depends_on:
          - influxdb
        volumes:
          - ./telegraf.conf:/etc/telegraf/telegraf.conf:ro
          - ~/docker/traefik/ssl:/etc/ssl/certs/nodesathome:ro
        networks:
          - backbone
